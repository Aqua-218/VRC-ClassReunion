// =============================================================================
// VRC同期会Discord Bot - Prisma Schema
// =============================================================================
// Database: PostgreSQL 14+ (Production) / SQLite 3.40+ (Development)
// ORM: Prisma 5.8+
// Last Updated: 2025-11-16
// =============================================================================

generator client {
  provider        = "prisma-client-js"
  previewFeatures = []
  binaryTargets   = ["native", "debian-openssl-3.0.x"] // Linux deployment support
}

datasource db {
  provider = "sqlite" // Development: SQLite for local development
  url      = env("DATABASE_URL")
}

// =============================================================================
// INVITATION (お誘い募集マスター)
// =============================================================================
// Business: VRChatイベント募集情報の管理、Discord Forumスレッドと1:1対応
// Relations: 1:N with Participant
// Data Volume: 600 records/year (Phase 1) → 1,200/year (Phase 3)
// Access Pattern: Read-Heavy (70% read, 30% write)
// =============================================================================
model Invitation {
  // Primary Key
  id String @id // Discord Message ID (Snowflake, 20 chars)

  // Discord Integration
  threadId       String  @unique // Discord Thread/Post ID (Snowflake, 20 chars)
  staffMessageId String? // Staff notification message ID (20 chars)

  // Host Information (Snapshot)
  hostId   String // Discord User ID (Snowflake, 20 chars)
  hostName String // Host display name (snapshot for history, max 100 chars)

  // Event Details
  eventName   String   // Event title (1-200 chars, no newlines)
  startTime   DateTime // Event start time (timezone-aware)
  endTime     DateTime // Event end time (must be > startTime)
  worldName   String   // VRChat world name (max 200 chars)
  worldLink   String?  // VRChat world URL (https://vrchat.com/..., max 500 chars)
  tag         String   // Category tag (観光/ゲーム/まったり/撮影会/イベント/その他, max 50 chars)
  description String   // Event description (max 2000 chars)

  // VRChat Instance Settings
  instanceType    String  // group | friend | friendplus | public (max 20 chars)
  vrchatProfile   String? // VRChat profile URL (ENCRYPTED, required for friend*, max 500 chars)
  instanceLink    String? // Instance invite link (ENCRYPTED, staff input, max 500 chars)
  maxParticipants Int     // Max participants (1-100)

  // Status Management
  status String @default("recruiting") // recruiting | full | completed | cancelled (max 20 chars)

  // Staff Assignment (for group instances)
  staffId   String? // Assigned staff Discord User ID (20 chars)
  staffName String? // Assigned staff name (snapshot, max 100 chars)

  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  participants Participant[]

  // Indexes (Optimized for Query Patterns)
  @@index([status, tag, startTime], name: "idx_invitation_list") // Q1: List with filters
  @@index([hostId, startTime], name: "idx_invitation_host") // Host's events
  @@index([status, endTime], name: "idx_invitation_auto_close") // Q4: Auto-close cron
  @@index([startTime], name: "idx_invitation_recent") // Recent events
  @@map("invitations")
}

// =============================================================================
// PARTICIPANT (参加者情報)
// =============================================================================
// Business: イベント参加者の管理、1ユーザー×1募集につき1レコード
// Relations: N:1 with Invitation (CASCADE DELETE)
// Data Volume: 4,800 records/year (Phase 1) → 12,000/year (Phase 3)
// Access Pattern: High read (participant lists), Moderate write (join/leave)
// =============================================================================
model Participant {
  // Primary Key (Surrogate)
  id Int @id @default(autoincrement())

  // Foreign Key
  invitationId String // → Invitation.id (CASCADE DELETE, 20 chars)

  // User Information (Snapshot)
  userId   String // Discord User ID (Snowflake, 20 chars)
  userName String // User display name (snapshot for history, max 100 chars)

  // Participation Status
  status String // joined (confirmed) | interested (maybe), max 20 chars

  // Timestamp
  createdAt DateTime @default(now())

  // Relations
  invitation Invitation @relation(fields: [invitationId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  // Constraints & Indexes
  @@unique([invitationId, userId], name: "unique_participant") // Prevent duplicate participation
  @@index([userId, createdAt], name: "idx_participant_user_history") // Q3: User's participation history
  @@index([invitationId, status], name: "idx_participant_invitation_status") // Count joined participants
  @@map("participants")
}

// =============================================================================
// TICKET (チケット情報)
// =============================================================================
// Business: サポートチケット管理、Discord Private Channelと1:1対応
// Relations: None (Independent entity)
// Data Volume: 180 records/year (Phase 1) → 300/year (Phase 3)
// Access Pattern: Moderate read (open tickets list), Low write (create/close)
// =============================================================================
model Ticket {
  // Primary Key
  id String @id // Discord Private Channel ID (Snowflake, 20 chars)

  // User Information (Snapshot)
  userId   String // Ticket creator Discord User ID (20 chars)
  userName String // Creator display name (snapshot, max 100 chars)

  // Ticket Details
  category    String // question | trouble | other (max 50 chars)
  description String // Ticket description (max 2000 chars)
  status      String @default("open") // open | closed (max 20 chars)

  // Timestamps
  createdAt DateTime  @default(now())
  closedAt  DateTime? // Set when ticket is closed

  // Indexes
  @@index([status, createdAt], name: "idx_ticket_open") // Open tickets list
  @@index([userId, createdAt], name: "idx_ticket_user_history") // User's ticket history
  @@map("tickets")
}
