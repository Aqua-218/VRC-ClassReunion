# 技術スタック詳細

## 1. 技術スタック全体像

### 1.1 技術スタックサマリー

| レイヤー | 技術 | バージョン | ライセンス |
|---------|------|----------|----------|
| **Runtime** | Node.js | v18 LTS+ | MIT |
| **言語** | TypeScript | v5.3+ | Apache 2.0 |
| **Discord SDK** | discord.js | v14.14+ | Apache 2.0 |
| **ORM** | Prisma | v5.8+ | Apache 2.0 |
| **DB (本番)** | PostgreSQL | v14+ | PostgreSQL License |
| **DB (開発)** | SQLite | v3.40+ | Public Domain |
| **バリデーション** | Zod | v3.22+ | MIT |
| **ログ** | Winston | v3.11+ | MIT |
| **スケジューラ** | node-cron | v3.0+ | ISC |
| **日時処理** | date-fns | v2.30+ | MIT |
| **テスト** | Jest | v29.7+ | MIT |
| **リンター** | ESLint | v8.56+ | MIT |
| **フォーマッター** | Prettier | v3.1+ | MIT |

---

## 2. コア技術の選定理由と評価

### 2.1 プログラミング言語: TypeScript

#### 選定理由

| 理由 | 詳細 |
|------|------|
| **型安全性** | コンパイル時にバグを検出、大規模プロジェクトの保守性向上 |
| **Discord.js統合** | discord.js v14は完全TypeScript対応、優れた型推論 |
| **開発者体験** | IDEの自動補完、リファクタリング支援 |
| **コミュニティ** | Node.jsエコシステムで標準、豊富なライブラリ |

#### 代替案との比較

| 項目 | TypeScript | JavaScript | Python (discord.py) |
|------|-----------|-----------|-------------------|
| 型安全性 | ⭐⭐⭐⭐⭐ | ⭐ | ⭐⭐⭐ |
| 開発速度 | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| パフォーマンス | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| Discord SDK成熟度 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| エコシステム | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 保守性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |

**決定**: TypeScript（厳格モード）を採用

**技術的リスク**: 
- 学習曲線: 軽減策: 段階的な型定義、チーム教育
- ビルド時間増加: 軽減策: esbuild等の高速ビルドツール検討

---

### 2.2 Discord SDK: discord.js v14

#### 選定理由

| 理由 | 詳細 |
|------|------|
| **最新API対応** | Discord API v10完全対応、Interactions API完全サポート |
| **型定義完備** | TypeScriptファーストな設計、型推論が優秀 |
| **コミュニティ** | 最も使用されているNode.js Discord SDK、豊富なドキュメント |
| **アクティブ開発** | 定期的なアップデート、セキュリティパッチ迅速 |

#### バージョン選定

| バージョン | 対応Discord API | 選定理由 |
|----------|---------------|---------|
| **v14 (採用)** | API v10 | Interactions API完全対応、モーダル・フォーラムサポート |
| v13 | API v9 | 古いAPI、モーダル未対応 |

#### 代替案との比較

| 項目 | discord.js | Eris | Oceanic |
|------|-----------|------|---------|
| TypeScript対応 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| ドキュメント | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ |
| コミュニティ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐ |
| 最新機能対応 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| パフォーマンス | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

**決定**: discord.js v14

**技術的リスク**:
- メモリ使用量: 軽減策: キャッシュ設定の最適化
- 破壊的変更: 軽減策: LTSバージョン固定、段階的アップグレード

---

### 2.3 ORM: Prisma

#### 選定理由

| 理由 | 詳細 |
|------|------|
| **型安全性** | スキーマからTypeScript型を自動生成、コンパイル時エラー検出 |
| **マイグレーション** | 宣言的スキーマ定義、自動マイグレーションファイル生成 |
| **開発者体験** | Prisma Studio（GUI）、優れたクエリAPI |
| **パフォーマンス** | 最適化されたクエリ生成、コネクションプール管理 |

#### 代替案との比較

| 項目 | Prisma | TypeORM | Sequelize | Drizzle |
|------|--------|---------|-----------|---------|
| TypeScript統合 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| マイグレーション | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 学習曲線 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ |
| パフォーマンス | ⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| エコシステム | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |

**決定**: Prisma

**技術的リスク**:
- Prisma Client サイズ大: 軽減策: 許容範囲（~10MB）
- 複雑なクエリの制約: 軽減策: 生SQLフォールバック可能

---

### 2.4 データベース: PostgreSQL (本番) / SQLite (開発)

#### PostgreSQL 選定理由

| 理由 | 詳細 |
|------|------|
| **信頼性** | ACID特性完全準拠、データ整合性保証 |
| **スケーラビリティ** | 水平・垂直スケーリング両対応、レプリケーション |
| **機能豊富** | JSONB、全文検索、トランザクション分離レベル細かい制御 |
| **無料ホスティング** | Supabase、Neon等の無料枠が豊富 |

#### SQLite 選定理由（開発環境）

| 理由 | 詳細 |
|------|------|
| **セットアップ不要** | ファイルベース、環境構築が容易 |
| **ポータビリティ** | ローカル開発でDB起動不要 |
| **高速** | メモリ内DBとして利用可能 |

#### 代替案との比較（本番DB）

| 項目 | PostgreSQL | MySQL | MongoDB |
|------|-----------|-------|---------|
| ACID準拠 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| TypeScript統合 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 無料ホスティング | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| スケーラビリティ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| データモデル適合 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |

**決定**: PostgreSQL（本番）、SQLite（開発）

**技術的リスク**:
- PostgreSQL運用コスト: 軽減策: 無料ホスティング活用、自動バックアップ
- 開発本番の差異: 軽減策: Prismaが差異を吸収、本番同等環境のDockerコンテナ

---

### 2.5 バリデーション: Zod

#### 選定理由

| 理由 | 詳細 |
|------|------|
| **型推論** | スキーマからTypeScript型を自動推論 |
| **宣言的API** | 可読性の高いスキーマ定義 |
| **エラーメッセージ** | カスタマイズ可能な詳細エラー |
| **軽量** | バンドルサイズ小、依存なし |

#### 代替案との比較

| 項目 | Zod | Joi | Yup | io-ts |
|------|-----|-----|-----|-------|
| TypeScript統合 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| バンドルサイズ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| エラーメッセージ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| 学習曲線 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |

**決定**: Zod

---

### 2.6 ログ: Winston

#### 選定理由

| 理由 | 詳細 |
|------|------|
| **構造化ログ** | JSON形式、メタデータ付与 |
| **柔軟な出力先** | Console、ファイル、外部サービス（Datadog等） |
| **ログレベル** | ERROR、WARN、INFO、DEBUG の細かい制御 |
| **実績** | Node.jsエコシステムで標準 |

#### 代替案との比較

| 項目 | Winston | Pino | Bunyan |
|------|---------|------|--------|
| パフォーマンス | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| 機能性 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| エコシステム | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |
| ドキュメント | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | ⭐⭐⭐ |

**決定**: Winston（Phase 1）、Pino（Phase 2で性能要件厳しい場合検討）

---

## 3. ライセンス考慮事項

### 3.1 使用ライセンス一覧

| 技術 | ライセンス | 商用利用 | コピーレフト |
|------|----------|---------|------------|
| Node.js | MIT | ✅ | ❌ |
| TypeScript | Apache 2.0 | ✅ | ❌ |
| discord.js | Apache 2.0 | ✅ | ❌ |
| Prisma | Apache 2.0 | ✅ | ❌ |
| PostgreSQL | PostgreSQL License | ✅ | ❌ |
| SQLite | Public Domain | ✅ | ❌ |
| Zod | MIT | ✅ | ❌ |
| Winston | MIT | ✅ | ❌ |

**結論**: 全て商用利用可能なパーミッシブライセンス、法的リスクなし

---

## 4. サポート・コミュニティ状況

### 4.1 コミュニティ規模

| 技術 | GitHub Stars | npm週間DL | Discord/Forum |
|------|-------------|----------|--------------|
| discord.js | 24k+ | 1.2M+ | 公式Discord 250k+ |
| Prisma | 35k+ | 2.5M+ | 公式Slack 50k+ |
| Zod | 28k+ | 8M+ | GitHub Discussions |
| Winston | 21k+ | 10M+ | GitHub Issues |

**評価**: 全て活発なコミュニティ、質問への回答が迅速

### 4.2 企業サポート

| 技術 | 企業サポート | 商用サポート |
|------|------------|------------|
| Prisma | Prisma Data (企業) | あり（有償） |
| PostgreSQL | PostgreSQL Global Development Group | あり（サードパーティ） |
| discord.js | Discord公式非公認だが支援 | なし |

---

## 5. 学習曲線とオンボーディング

### 5.1 技術習得難易度

| 技術 | 初学者 | 中級者 | 習得時間 |
|------|-------|-------|---------|
| TypeScript | ⭐⭐⭐ | ⭐⭐⭐⭐ | 1-2週間 |
| discord.js | ⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 2-3日 |
| Prisma | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | 1-2日 |
| PostgreSQL | ⭐⭐⭐ | ⭐⭐⭐⭐ | 基礎: 1週間 |

### 5.2 オンボーディング資料

| 技術 | 公式ドキュメント | チュートリアル | 動画教材 |
|------|---------------|-------------|---------|
| TypeScript | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ |
| discord.js | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |
| Prisma | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ |

**新規開発者のオンボーディング計画**:
1. 週1: TypeScript基礎、discord.js公式ガイド
2. 週2: Prismaクイックスタート、本プロジェクトコード読解
3. 週3: 小機能の実装、プルリクエスト

---

## 6. パフォーマンス特性

### 6.1 ベンチマーク比較

#### discord.js メモリ使用量

| キャッシュ設定 | メモリ使用量 | 応答速度 |
|--------------|------------|---------|
| Full Cache | ~500MB | 即座 |
| Limited Cache (推奨) | ~200MB | 50-100ms |
| Minimal Cache | ~100MB | 100-200ms |

**採用**: Limited Cache（メモリとパフォーマンスのバランス）

#### Prisma クエリパフォーマンス

| 操作 | 所要時間 (P95) | 備考 |
|------|---------------|------|
| 単純SELECT | ~10ms | インデックス使用 |
| JOIN (1:N) | ~20ms | Participantテーブル結合 |
| INSERT | ~15ms | トランザクション使用 |
| UPDATE | ~18ms | WHERE条件インデックス化 |

---

## 7. 撤退戦略（技術変更が必要な場合）

### 7.1 技術変更時のコスト評価

| 技術 | 変更難易度 | 影響範囲 | 推定工数 |
|------|----------|---------|---------|
| discord.js → 別SDK | ⭐⭐⭐⭐⭐ | 全体 | 3-4週間 |
| Prisma → TypeORM | ⭐⭐⭐⭐ | Data Access Layer | 2-3週間 |
| PostgreSQL → MySQL | ⭐⭐ | Prisma設定のみ | 1-2日 |
| Winston → Pino | ⭐ | ログ設定のみ | 1日 |

### 7.2 ベンダーロックイン評価

| 技術 | ロックイン度 | リスク評価 |
|------|-----------|----------|
| Discord Platform | ⭐⭐⭐⭐⭐ | 高（代替不可） |
| Prisma | ⭐⭐⭐ | 中（ORM変更は影響大） |
| PostgreSQL | ⭐⭐ | 低（標準SQL移行容易） |

**リスク軽減策**:
- ビジネスロジックをDiscord依存から分離（Serviceレイヤー）
- Prismaの生SQL機能活用でORM非依存のクエリも混在可能
- データベースはPrismaが抽象化、変更時の影響最小限

---

## 8. セキュリティ評価

### 8.1 既知の脆弱性管理

| 技術 | CVE追跡 | 自動更新 |
|------|--------|---------|
| discord.js | GitHub Dependabot | ✅ |
| Prisma | GitHub Dependabot | ✅ |
| PostgreSQL | 公式セキュリティ情報 | 手動更新 |

### 8.2 セキュリティベストプラクティス

| 技術 | 推奨設定 | 実装 |
|------|---------|------|
| TypeScript | strict モード | ✅ |
| Prisma | parameterized queries | ✅（デフォルト） |
| Winston | ログにPII含めない | ✅（設定で制御） |
| PostgreSQL | SSL接続 | ✅（本番環境） |

---

## 9. コスト分析

### 9.1 ライセンスコスト

| 技術 | 月額コスト | 年間コスト |
|------|----------|----------|
| 全技術 | ¥0 | ¥0 |

**評価**: 全てオープンソース、ライセンス費用ゼロ

### 9.2 運用コスト（推定）

| 項目 | 月額コスト |
|------|----------|
| PostgreSQLホスティング（Supabase無料枠） | ¥0 |
| VPS（Contabo/Vultr） | ¥500-1,000 |
| ドメイン（オプション） | ¥100 |
| **合計** | **¥600-1,100** |

---

## 10. 技術的負債とアップグレード戦略

### 10.1 依存関係の更新ポリシー

| 更新種別 | 頻度 | 承認 |
|---------|------|------|
| セキュリティパッチ | 即座 | 自動 |
| マイナーバージョン | 月次 | レビュー後 |
| メジャーバージョン | 四半期 | アーキテクト承認 |

### 10.2 EOL（End of Life）監視

| 技術 | 現バージョン | EOL予定 | 対応 |
|------|------------|--------|------|
| Node.js 18 | LTS | 2025年4月 | 2024年中にv20移行 |
| discord.js v14 | 最新 | 未定 | 公式発表を監視 |
| PostgreSQL 14 | 安定 | 2026年11月 | 長期サポート |

---

## 関連ドキュメント

- [アーキテクチャ概要](./architecture/overview.md)
- [データベーススキーマ](./database/schema.md)
- [セキュリティ設計](./security/threat-model.md)
- [ADR: TypeScript選定](./decisions/0001-typescript-selection.md)
- [ADR: Prisma ORM採用](./decisions/0002-prisma-orm.md)

---

**最終更新**: 2025年11月16日  
**ドキュメントバージョン**: 1.0.0  
**レビュアー**: -
