# 要件定義

## 1. ビジネス要件と背景

### 1.1 プロジェクト背景

VRC同期会コミュニティは、VRChatプラットフォーム上で定期的に活動する約400名規模のコミュニティです。従来、イベント募集やコミュニティサポートは以下の手段で行われていました:

| 従来の手段 | 課題 |
|----------|------|
| テキストチャンネルでの募集投稿 | 情報が流れて過去の募集が追跡困難、参加管理が煩雑 |
| リアクションベースの参加表明 | 編集不可、参加者リストの可視化が悪い、定員管理が手動 |
| スタッフDMでのサポート | 対応履歴が残らない、担当の重複・抜け漏れ発生 |
| 手動グループインスタンス管理 | 担当スタッフへの連絡が属人化、情報伝達漏れ |

### 1.2 ビジネス目標

1. **イベント参加率30%向上**: 募集の可視性向上と参加の容易化により、平均参加者数を6名→8名に
2. **スタッフ作業時間50%削減**: 自動化により、月間100時間のスタッフ工数を50時間に削減
3. **ユーザー満足度向上**: Bot利用満足度4.5/5.0以上を維持
4. **コミュニティ活性化**: 月間イベント開催数を30件→50件に増加

### 1.3 ROI（投資対効果）

| 項目 | 現状（月間） | 目標（月間） | 効果 |
|------|------------|------------|------|
| スタッフ人件費（仮想） | 100時間 × ¥2,000 = ¥200,000 | 50時間 × ¥2,000 = ¥100,000 | **¥100,000削減** |
| イベント開催数 | 30件 | 50件 | **67%増加** |
| 平均参加者数 | 6名/イベント | 8名/イベント | **33%増加** |
| 運用コスト | なし | サーバー代¥5,000 | **¥5,000増加** |
| **純効果** | - | - | **月間¥95,000のコスト削減** |

---

## 2. ユーザーペルソナ

### ペルソナ1: 一般メンバー（参加者）

**基本情報**
- 名前: 田中 春花（仮名）
- 年齢: 25歳
- 職業: 会社員（IT業界）
- VRChat歴: 1年
- Discord利用頻度: 毎日（通知確認程度）

**行動特性**
- 平日夜21-24時、週末昼間にVRChatログイン
- 観光・撮影会イベントに興味あり
- 積極的な主催はしないが、気軽に参加したい
- スマホでDiscord確認することが多い

**ペインポイント**
- テキストチャンネルのイベント情報が流れて見逃す
- 参加表明したか忘れる
- イベント開始時刻を忘れる
- ワールドリンクを探すのが面倒

**期待する体験**
- ワンタップで参加表明
- 開始前にリマインダー通知
- 参加中のイベント一覧を確認できる
- ワールドリンクがすぐに見つかる

### ペルソナ2: イベント主催者

**基本情報**
- 名前: 佐藤 蒼空（仮名）
- 年齢: 30歳
- 職業: フリーランス（デザイナー）
- VRChat歴: 3年
- Discord利用頻度: 毎日（積極的）

**行動特性**
- 週1-2回イベントを主催
- ワールド探索が趣味で新規ワールドを紹介したい
- 参加者とのコミュニケーションを重視
- PCでDiscordを常時起動

**ペインポイント**
- 募集投稿を作るのに時間がかかる
- 参加者数の集計が手動で面倒
- 定員管理ができない
- 急用でキャンセルする際の連絡が大変

**期待する体験**
- テンプレート化された募集作成フォーム
- 自動参加者集計
- 定員到達の自動通知
- ワンクリックで全参加者に通知

### ペルソナ3: スタッフ

**基本情報**
- 名前: 鈴木 翔太（仮名）
- 年齢: 28歳
- 職業: エンジニア
- スタッフ歴: 1年
- 対応可能時間: 平日夜、週末

**行動特性**
- 月10-15件のグループインスタンス建て対応
- 月5-10件のチケット対応
- 他のスタッフと協力して対応
- 効率化・自動化に関心が高い

**ペインポイント**
- どのイベントが対応必要か探すのが手間
- 他のスタッフと重複対応してしまう
- インスタンス情報を参加者に伝える手順が煩雑
- チケット対応履歴が残らない

**期待する体験**
- 対応必要なイベントが自動通知される
- 早押しで担当を確定、重複を防止
- インスタンス情報を入力するだけで自動配信
- チケット対応履歴が自動記録される

---

## 3. ユーザーストーリー

### エピック1: お誘い募集システム

#### US-1.1: 募集作成
**As a** イベント主催者  
**I want to** ワンクリックで構造化されたイベント募集を作成したい  
**So that** 短時間で正確な募集情報を投稿できる

**受け入れ基準**
- [ ] `✨-募集を作成` チャンネルの「📝 募集を作成する」ボタンをクリックでモーダル表示
- [ ] モーダルに11項目の入力フォームが表示される
- [ ] 日時形式、URL形式、数値範囲のバリデーションが動作する
- [ ] バリデーションエラー時、具体的なエラーメッセージが表示される
- [ ] 送信後、フォーラムに新規スレッドが作成される
- [ ] 作成完了時、エフェメラルメッセージで成功通知が表示される

**優先度**: 最高  
**見積もり**: 8ポイント

---

#### US-1.2: 参加表明
**As a** 一般メンバー  
**I want to** イベントに簡単に参加表明したい  
**So that** 煩雑な手続きなく参加できる

**受け入れ基準**
- [ ] 募集投稿の「✅ 参加する」ボタンをクリックで参加表明
- [ ] 埋め込みメッセージの参加者リストに名前が追加される
- [ ] 既に参加表明している場合、エラーメッセージ表示
- [ ] 定員到達時、ボタンが無効化され、参加不可メッセージ表示
- [ ] データベースに参加記録が保存される

**優先度**: 最高  
**見積もり**: 5ポイント

---

#### US-1.3: 興味あり表明
**As a** 一般メンバー  
**I want to** 参加確約はできないが興味を示したい  
**So that** 主催者に需要を伝えつつ、柔軟に参加を検討できる

**受け入れ基準**
- [ ] 「❓ 興味あり」ボタンをクリックで興味あり表明
- [ ] 埋め込みメッセージの興味ありリストに名前が追加される
- [ ] 既に「参加」表明している場合、「参加」→「興味あり」に変更される
- [ ] 逆パターン（興味あり→参加）も同様に動作する

**優先度**: 高  
**見積もり**: 3ポイント

---

#### US-1.4: 参加取り消し
**As a** 一般メンバー  
**I want to** 参加表明を取り消したい  
**So that** 都合が悪くなった場合に対応できる

**受け入れ基準**
- [ ] 「🚫 参加取り消し」ボタンをクリックで取り消し
- [ ] 埋め込みメッセージから名前が削除される
- [ ] 定員到達状態だった場合、「募集中」に戻る
- [ ] 参加表明していない場合、エラーメッセージ表示

**優先度**: 高  
**見積もり**: 3ポイント

---

#### US-1.5: 募集編集
**As a** イベント主催者  
**I want to** 作成後の募集内容を編集したい  
**So that** 誤情報の修正や追加情報の提供ができる

**受け入れ基準**
- [ ] 主催者のみ「✏️ 編集」ボタンが押下可能
- [ ] 他のユーザーがクリック時、権限エラーが表示される
- [ ] 現在の入力内容がモーダルに自動入力される
- [ ] 編集後、埋め込みメッセージが更新される
- [ ] フォーラムスレッドに「募集内容が更新されました」と自動投稿
- [ ] 参加者全員にDM通知（オプション、環境変数で制御）

**優先度**: 高  
**見積もり**: 5ポイント

---

#### US-1.6: 募集キャンセル
**As a** イベント主催者  
**I want to** 急用でイベントをキャンセルしたい  
**So that** 参加者に迅速に通知できる

**受け入れ基準**
- [ ] 主催者のみ「❌ キャンセル」ボタンが押下可能
- [ ] 確認ダイアログが表示される
- [ ] 確認後、ステータスが「中止」に変更
- [ ] 埋め込みメッセージの色が灰色に変更
- [ ] 全ボタンが無効化される
- [ ] フォーラムタグが「中止」に変更
- [ ] 参加者全員にDMで中止通知
- [ ] スレッドがアーカイブされる

**優先度**: 高  
**見積もり**: 5ポイント

---

#### US-1.7: グループインスタンス管理
**As a** スタッフ  
**I want to** グループインスタンス必要な募集を効率的に担当したい  
**So that** 手動連絡なく対応でき、重複を防止できる

**受け入れ基準**
- [ ] インスタンスタイプ「グループ」の募集作成時、`🔧-インスタンス管理` に通知
- [ ] 「🙋 担当します」ボタンをスタッフがクリック
- [ ] 担当者がデータベースに記録される
- [ ] 既に担当者がいる場合、エラーメッセージ表示
- [ ] 募集投稿の埋め込みメッセージに担当者名が表示される
- [ ] 担当スタッフにDMで詳細情報が送信される

**優先度**: 高  
**見積もり**: 8ポイント

---

#### US-1.8: インスタンス情報入力
**As a** 担当スタッフ  
**I want to** インスタンスリンクを入力して参加者に通知したい  
**So that** 手動DMせずに全参加者に配信できる

**受け入れ基準**
- [ ] 担当スタッフのみ「🔗 インスタンス情報を入力」ボタンが表示される
- [ ] モーダルでインスタンスリンクを入力
- [ ] データベースに保存される
- [ ] 募集投稿の埋め込みメッセージにリンクが表示される
- [ ] 参加者全員にDMでリンクが通知される

**優先度**: 高  
**見積もり**: 5ポイント

---

#### US-1.9: 自動クローズ
**As a** システム  
**I want to** 終了日時を過ぎた募集を自動クローズしたい  
**So that** 手動管理なく募集が整理される

**受け入れ基準**
- [ ] 1時間ごとに全募集をチェック
- [ ] 終了日時を過ぎた「募集中」「定員到達」をクローズ
- [ ] ステータスタグを「開催済み」に変更
- [ ] 全ボタンを無効化
- [ ] オプション: スレッドをアーカイブ

**優先度**: 中  
**見積もり**: 3ポイント

---

#### US-1.10: リマインダー通知
**As a** 参加者  
**I want to** イベント開始1時間前に通知を受け取りたい  
**So that** 開始時刻を忘れずに参加できる

**受け入れ基準**
- [ ] 開始1時間前に参加者全員にDM送信
- [ ] 通知内容: イベント名、開始時刻、ワールド名、リンク、インスタンス情報
- [ ] 環境変数でリマインダー時間をカスタマイズ可能

**優先度**: 中  
**見積もり**: 5ポイント

---

### エピック2: チケットシステム

#### US-2.1: チケット作成
**As a** 一般メンバー  
**I want to** プライベートサポートチャンネルを作成したい  
**So that** 個人的な質問やトラブルを相談できる

**受け入れ基準**
- [ ] `🎫-サポート` チャンネルの「チケットを作成」ボタンをクリック
- [ ] カテゴリ選択モーダル表示（質問/トラブル報告/その他）
- [ ] プライベートチャンネル `ticket-{ユーザー名}-{連番}` が作成される
- [ ] 作成者とスタッフのみアクセス可能
- [ ] 初期メッセージでスタッフに通知
- [ ] 「✅ クローズ」ボタンが配置される

**優先度**: 高  
**見積もり**: 8ポイント

---

#### US-2.2: チケットクローズ
**As a** スタッフまたは作成者  
**I want to** チケットをクローズしたい  
**So that** 解決済みチケットを整理できる

**受け入れ基準**
- [ ] 「✅ クローズ」ボタンをクリック
- [ ] 確認ダイアログ表示
- [ ] 確認後、チャンネルが削除またはアーカイブ
- [ ] データベースのステータスが「closed」に更新
- [ ] クローズ日時が記録される

**優先度**: 高  
**見積もり**: 3ポイント

---

## 4. 機能要件

### 4.1 お誘い募集システム

| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| F-INV-001 | 募集作成 | モーダルUIでイベント募集を作成 | 最高 |
| F-INV-002 | 募集表示 | フォーラムスレッドに埋め込みメッセージで表示 | 最高 |
| F-INV-003 | 参加管理 | ボタンクリックで参加/興味あり/取り消し | 最高 |
| F-INV-004 | 定員管理 | 上限到達時の自動ボタン無効化 | 高 |
| F-INV-005 | 募集編集 | 主催者による募集内容の更新 | 高 |
| F-INV-006 | 募集キャンセル | 主催者による中止処理 | 高 |
| F-INV-007 | スタッフ通知 | グループインスタンス必要な募集の通知 | 高 |
| F-INV-008 | 担当割当 | 早押し方式のスタッフ担当確定 | 高 |
| F-INV-009 | インスタンス情報入力 | 担当スタッフによるリンク入力 | 高 |
| F-INV-010 | 自動クローズ | 終了日時経過後の自動クローズ | 中 |
| F-INV-011 | リマインダー | 開始前の参加者通知 | 中 |
| F-INV-012 | タグ管理 | フォーラムタグの自動付与・更新 | 高 |

### 4.2 チケットシステム

| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| F-TKT-001 | チケット作成 | プライベートチャンネルの自動生成 | 高 |
| F-TKT-002 | カテゴリ分類 | 質問/トラブル報告/その他 | 中 |
| F-TKT-003 | チケットクローズ | チャンネル削除/アーカイブ | 高 |
| F-TKT-004 | 権限管理 | 作成者とスタッフのみアクセス可能 | 高 |

### 4.3 管理機能

| 機能ID | 機能名 | 説明 | 優先度 |
|--------|--------|------|--------|
| F-ADM-001 | 初期セットアップ | `/setup` コマンドによるチャンネル・メッセージ作成 | 最高 |
| F-ADM-002 | ログ記録 | 全操作のログ記録 | 高 |
| F-ADM-003 | エラーハンドリング | 包括的なエラー処理 | 高 |

---

## 5. 非機能要件

### 5.1 性能要件

| 項目 | 目標値 | 測定方法 |
|------|--------|---------|
| インタラクション応答時間 | P95で500ms以内 | APMツール |
| データベースクエリ時間 | P95で100ms以内 | Prisma Metrics |
| 同時インタラクション処理 | 50リクエスト/秒 | 負荷テスト |
| メモリ使用量 | 常時500MB以下 | サーバー監視 |
| CPU使用率 | 平均20%以下 | サーバー監視 |

### 5.2 可用性要件

| 項目 | 目標値 | 説明 |
|------|--------|------|
| アップタイム | 99.9%（月間43分以内のダウンタイム） | 計画メンテナンス除く |
| MTBF（平均故障間隔） | 720時間（30日） | 重大障害の間隔 |
| MTTR（平均復旧時間） | 1時間以内 | 障害検知から復旧まで |
| データバックアップ | 1日1回、世代管理7日分 | 自動バックアップ |

### 5.3 セキュリティ要件

| 項目 | 要件 | 実装方法 |
|------|------|---------|
| 認証 | Discord OAuth 2.0 | discord.js標準機能 |
| 認可 | ロールベースアクセス制御 | Discord Role検証 |
| データ暗号化 | 転送時: TLS 1.3、保管時: DB暗号化 | PostgreSQL暗号化、Discord HTTPS |
| 機密情報管理 | 環境変数で管理、Gitにコミットしない | .envファイル、.gitignore |
| 入力検証 | 全ユーザー入力のバリデーション | Zod等のスキーマバリデーション |
| SQLインジェクション対策 | ORMのパラメータ化クエリ | Prisma使用 |
| レート制限 | ボタンクリック1秒1回、募集作成5分1回 | インメモリキャッシュ |

### 5.4 保守性要件

| 項目 | 要件 |
|------|------|
| コードカバレッジ | 80%以上 |
| ドキュメント整備 | 全API・関数にJSDoc、アーキテクチャ図最新化 |
| ログレベル | ERROR、WARN、INFO、DEBUG の4段階 |
| エラー追跡 | スタックトレース、コンテキスト情報を含む |
| 設定の柔軟性 | 環境変数で主要設定を変更可能 |

### 5.5 拡張性要件

| 項目 | 要件 |
|------|------|
| ユーザー数スケール | 400名→2000名まで対応 |
| 同時募集数 | 100件まで問題なく処理 |
| データベース拡張 | PostgreSQLの垂直・水平スケーリング対応 |
| モジュール追加 | 新機能追加時、既存機能への影響最小限 |

### 5.6 互換性要件

| 項目 | 要件 |
|------|------|
| Discord API | v10以降 |
| discord.js | v14.x |
| Node.js | v18.x以降（LTS） |
| PostgreSQL | v14以降 |
| SQLite | v3.x（開発環境） |

### 5.7 ユーザビリティ要件

| 項目 | 要件 |
|------|------|
| 学習時間 | 新規ユーザーが基本操作を5分以内に習得 |
| エラーメッセージ | 具体的な解決策を含む |
| 応答フィードバック | 全操作に対して0.5秒以内に視覚的フィードバック |
| モバイル対応 | Discord モバイルアプリで全機能利用可能 |

---

## 6. 制約条件

### 6.1 技術的制約

| 制約 | 詳細 | 影響 |
|------|------|------|
| Discord API Rate Limit | 50リクエスト/秒（グローバル） | バースト処理時の遅延 |
| モーダル入力項目数 | 最大5項目 | 募集作成を複数ページに分割する可能性 |
| 埋め込みメッセージサイズ | 6000文字以内 | 長文説明の制限 |
| ボタン数 | 25個/メッセージ | 複雑なUIは分割が必要 |
| フォーラムタグ数 | 最大20個/チャンネル | タグ設計の慎重な検討 |

### 6.2 ビジネス的制約

| 制約 | 詳細 |
|------|------|
| 予算 | 運用コスト月額¥10,000以内 |
| 開発期間 | MVP: 3ヶ月、フルリリース: 6ヶ月 |
| 開発体制 | 1-2名のボランティア開発者 |

### 6.3 法的・規約制約

| 制約 | 詳細 |
|------|------|
| Discord利用規約 | スパム・自動化の禁止事項遵守 |
| GDPR/個人情報保護 | ユーザーIDのみ保存、削除要求対応 |
| VRChat利用規約 | API利用は非公式のため注意 |

---

## 7. スコープ管理

### 7.1 MVP（Phase 1）に含む

- ✅ お誘い募集システムの基本機能（作成・参加・編集・キャンセル）
- ✅ グループインスタンス管理（担当割当・情報入力）
- ✅ チケットシステム基本機能（作成・クローズ）
- ✅ データベース基盤（Prisma + PostgreSQL）
- ✅ 環境変数による設定管理

### 7.2 Phase 2に含む

- 📅 自動クローズ機能
- 📅 リマインダー通知
- 📅 統計ダッシュボード（管理者向け）
- 📅 検索機能（過去の募集検索）

### 7.3 将来検討（Phase 3以降）

- 🔮 Google Calendar連携
- 🔮 VRChat API連携（ワールド情報自動取得）
- 🔮 ユーザー個別通知設定
- 🔮 多言語対応
- 🔮 Webダッシュボード

### 7.4 明示的に含まない

- ❌ VRChat内での操作（Botは外部システム）
- ❌ 決済機能（有料イベント）
- ❌ 外部SNS連携（Twitter/X等）

---

## 8. 依存関係と前提条件

### 8.1 前提条件

1. Discord サーバーが既に存在する
2. Bot用のDiscord Application が作成済み
3. 開発者がTypeScript、discord.js の基礎知識を持つ
4. PostgreSQL または SQLite が利用可能な環境

### 8.2 外部依存

| 依存先 | 依存内容 | リスク | 軽減策 |
|--------|---------|--------|--------|
| Discord API | 全機能の基盤 | API仕様変更、ダウンタイム | discord.js最新版追従、エラーハンドリング強化 |
| PostgreSQL | データ永続化 | DBダウン、データ破損 | 定期バックアップ、レプリケーション検討 |
| VRChat | ワールド情報 | URL形式変更 | URLバリデーション柔軟化 |

---

## 9. リスクと軽減策

### 9.1 技術的リスク

| リスク | 影響度 | 発生確率 | 軽減策 |
|--------|--------|---------|--------|
| Discord API Rate Limit超過 | 高 | 中 | レート制限監視、バックオフ実装 |
| データベース肥大化 | 中 | 高 | 古いデータの自動削除、パーティショニング |
| メモリリーク | 高 | 低 | メモリ監視、定期再起動 |
| discord.js破壊的変更 | 中 | 中 | バージョン固定、マイグレーションガイド確認 |

### 9.2 ビジネスリスク

| リスク | 影響度 | 発生確率 | 軽減策 |
|--------|--------|---------|--------|
| ユーザー採用率低下 | 高 | 中 | オンボーディング改善、サポート強化 |
| スタッフ離脱 | 中 | 中 | ドキュメント整備、操作簡素化 |
| サーバーコスト増大 | 低 | 低 | コスト監視、最適化 |

### 9.3 運用リスク

| リスク | 影響度 | 発生確率 | 軽減策 |
|--------|--------|---------|--------|
| 開発者不在 | 高 | 中 | ドキュメント充実、コードの可読性向上 |
| セキュリティ脆弱性 | 高 | 低 | 依存関係の定期更新、セキュリティスキャン |

---

## 10. 包括的用語集

| 用語 | 説明 |
|------|------|
| **同期会** | VRChatで同じ時間にログインしてコミュニケーションを取る会 |
| **お誘い** | VRChatでのイベントやワールド巡りへの参加募集 |
| **グループインスタンス** | VRChatのグループ機能を使った招待制のインスタンス。スタッフ対応が必要 |
| **フレンドインスタンス** | フレンドのみが参加できるインスタンス。主催者のフレンド登録が必要 |
| **フレンド+インスタンス** | フレンドとそのフレンドが参加できるインスタンス |
| **パブリックインスタンス** | 誰でも参加可能なインスタンス |
| **チケット** | サポートや相談用のプライベートチャンネル |
| **埋め込みメッセージ (Embed)** | Discordのリッチな表示形式のメッセージ |
| **モーダル (Modal)** | ポップアップ形式の入力フォーム |
| **エフェメラル (Ephemeral)** | 本人にのみ表示される一時的なメッセージ |
| **インタラクション (Interaction)** | ボタンクリック、モーダル送信等のユーザー操作 |
| **フォーラムチャンネル** | スレッド形式の投稿が可能なDiscordチャンネル |
| **スレッド (Thread)** | フォーラムチャンネル内の個別投稿 |
| **タグ** | フォーラム投稿の分類ラベル（カテゴリ、ステータス等） |
| **スタッフロール** | Discord上でスタッフ権限を持つロール |
| **Intent** | Discord Botが受信するイベントの種類 |
| **ORM (Object-Relational Mapping)** | データベース操作をオブジェクト指向的に扱う技術（本プロジェクトではPrisma） |
| **ADR (Architecture Decision Record)** | アーキテクチャ上の重要な決定を記録するドキュメント |
| **MVP (Minimum Viable Product)** | 最小限の機能を持つ実用可能な製品 |

---

**最終更新**: 2025年11月16日  
**ドキュメントバージョン**: 1.0.0  
**レビュアー**: -  
**承認者**: -

---

## 関連ドキュメント

- [プロジェクト概要](./README.md)
- [アーキテクチャ概要](./architecture/overview.md)
- [詳細設計](./architecture/detailed-design.md)
- [ロードマップ](./roadmap.md)
