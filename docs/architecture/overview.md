# アーキテクチャ概要

## 1. システム全体像

### 1.1 鳥瞰図

```
┌─────────────────────────────────────────────────────────────────┐
│                         Discord クライアント                      │
│          (Web/Desktop/Mobile - ユーザー操作インターフェース)       │
└────────────┬────────────────────────────────────────┬────────────┘
             │                                        │
             │ HTTPS (TLS 1.3)                       │ HTTPS
             │ Gateway WebSocket                      │ REST API
             │                                        │
┌────────────▼────────────────────────────────────────▼────────────┐
│                         Discord Platform                         │
│  ┌──────────────┐  ┌──────────────┐  ┌─────────────────────┐   │
│  │  Gateway API │  │   REST API   │  │  Interactions API   │   │
│  │  (Events)    │  │  (Commands)  │  │  (Buttons/Modals)   │   │
│  └──────┬───────┘  └──────┬───────┘  └──────────┬──────────┘   │
└─────────┼──────────────────┼─────────────────────┼──────────────┘
          │                  │                     │
          │ Events           │ API Calls           │ Interactions
          │ (WebSocket)      │ (HTTPS)             │ (HTTPS)
          │                  │                     │
┌─────────▼──────────────────▼─────────────────────▼──────────────┐
│                   VRC同期会Discord Bot                           │
│  ┌──────────────────────────────────────────────────────────┐   │
│  │                  Application Layer                       │   │
│  │  ┌────────────┐  ┌────────────┐  ┌──────────────────┐   │   │
│  │  │ Event      │  │ Command    │  │  Interaction     │   │   │
│  │  │ Handlers   │  │ Handlers   │  │  Handlers        │   │   │
│  │  └─────┬──────┘  └─────┬──────┘  └────────┬─────────┘   │   │
│  └────────┼───────────────┼──────────────────┼─────────────┘   │
│           │               │                  │                  │
│  ┌────────▼───────────────▼──────────────────▼─────────────┐   │
│  │                  Business Logic Layer                    │   │
│  │  ┌────────────────┐  ┌────────────────┐  ┌───────────┐  │   │
│  │  │  Invitation    │  │    Ticket      │  │  Staff    │  │   │
│  │  │  Service       │  │    Service     │  │  Service  │  │   │
│  │  └────────┬───────┘  └────────┬───────┘  └─────┬─────┘  │   │
│  └───────────┼──────────────────┼────────────────┼────────┘   │
│              │                  │                │             │
│  ┌───────────▼──────────────────▼────────────────▼────────┐   │
│  │                   Data Access Layer                     │   │
│  │  ┌─────────────────────────────────────────────────┐    │   │
│  │  │          Prisma ORM (Type-safe)                 │    │   │
│  │  └─────────────────┬───────────────────────────────┘    │   │
│  └────────────────────┼──────────────────────────────────┘   │
│                       │                                       │
│  ┌────────────────────▼──────────────────────────────────┐   │
│  │               Cross-Cutting Concerns                  │   │
│  │  [Logging] [Validation] [Error Handling] [Scheduler]  │   │
│  └───────────────────────────────────────────────────────┘   │
└─────────────────────────┬─────────────────────────────────────┘
                          │
                          │ SQL (pg/sqlite)
                          │
┌─────────────────────────▼─────────────────────────────────────┐
│                    Database (PostgreSQL)                       │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ Invitation   │  │ Participant  │  │   Ticket     │         │
│  │   Table      │  │    Table     │  │    Table     │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└────────────────────────────────────────────────────────────────┘
```

### 1.2 複数視点のアーキテクチャ

#### C4モデル - レベル1: システムコンテキスト図

```
                    ┌──────────────────┐
                    │   一般メンバー    │
                    │   (400名)        │
                    └────────┬─────────┘
                             │
                    ┌────────▼─────────┐
                    │ イベント主催者   │
                    └────────┬─────────┘
                             │
                    ┌────────▼─────────┐
                    │   スタッフ       │
                    └────────┬─────────┘
                             │
                             │ Discord操作
                             │
┌────────────────────────────▼─────────────────────────────┐
│                                                           │
│                  Discord Platform                         │
│          (外部システム - メッセージング基盤)                 │
│                                                           │
└────────────────────────┬─────────────────────────────────┘
                         │
                         │ API/Gateway
                         │
┌────────────────────────▼─────────────────────────────────┐
│                                                           │
│              VRC同期会Discord Bot                         │
│         (本システム - イベント・チケット管理)                │
│                                                           │
└────────────────────────┬─────────────────────────────────┘
                         │
                         │ データ永続化
                         │
┌────────────────────────▼─────────────────────────────────┐
│                                                           │
│                  PostgreSQL Database                      │
│              (外部システム - データストア)                   │
│                                                           │
└───────────────────────────────────────────────────────────┘
```

---

## 2. アーキテクチャパターンと設計原則

### 2.1 採用アーキテクチャパターン

#### レイヤードアーキテクチャ（主要パターン）

```
┌─────────────────────────────────────────────┐
│      Presentation Layer (Discord UI)        │  ← Discord埋め込み、ボタン、モーダル
├─────────────────────────────────────────────┤
│      Application Layer (Handlers)           │  ← イベント/コマンド/インタラクション処理
├─────────────────────────────────────────────┤
│      Business Logic Layer (Services)        │  ← ドメインロジック、ビジネスルール
├─────────────────────────────────────────────┤
│      Data Access Layer (Prisma ORM)         │  ← データ永続化、クエリ
├─────────────────────────────────────────────┤
│      Database Layer (PostgreSQL)            │  ← データストレージ
└─────────────────────────────────────────────┘
```

**選定理由:**
- 明確な責務分離でテスト容易性向上
- 各層の独立性が高く、技術スタック変更時の影響範囲を限定
- チーム開発時の並行作業が容易

#### イベント駆動アーキテクチャ（補助パターン）

Discord Gatewayからのイベントを起点に処理を開始する非同期処理モデル。

```
Discord Event → Event Handler → Service Layer → DB Update → Discord API Call
```

**メリット:**
- ユーザー操作に対する即座の応答
- 疎結合な設計で拡張性が高い
- スケジューラーによる定期処理との統合が容易

### 2.2 設計原則

#### SOLID原則の適用

| 原則 | 適用方法 |
|------|---------|
| **単一責任** | 各Serviceクラスは1つの機能ドメインのみを担当（InvitationService、TicketService） |
| **開放閉鎖** | インターフェースを定義し、実装を差し替え可能に（DB層のPrismaを別のORMに交換可能） |
| **リスコフ置換** | 継承よりコンポジションを優先、型安全性を重視 |
| **インターフェース分離** | 小さなインターフェースに分割（IInvitationRepository、ITicketRepository） |
| **依存性逆転** | 上位層は抽象に依存、具体的な実装はDIで注入 |

#### 追加設計原則

- **DRY（Don't Repeat Yourself）**: 共通処理はutilsに集約
- **KISS（Keep It Simple, Stupid）**: 過度な抽象化を避け、実用的なシンプルさを維持
- **YAGNI（You Aren't Gonna Need It）**: 現時点で必要ない機能は実装しない
- **関心の分離**: UI層はビジネスロジックを持たない、Service層はDiscord APIを直接呼ばない

---

## 3. コンポーネント構成と責務分離

### 3.1 主要コンポーネント

#### 3.1.1 Application Layer

| コンポーネント | 責務 | 入力 | 出力 |
|--------------|------|------|------|
| **EventHandlers** | Discord Gatewayイベントの受信・振り分け | Discord Event | Service呼び出し |
| **CommandHandlers** | スラッシュコマンドの処理 | CommandInteraction | Discord応答 |
| **InteractionHandlers** | ボタン/モーダルの処理 | Interaction | Service呼び出し |

#### 3.1.2 Business Logic Layer

| コンポーネント | 責務 | 依存 |
|--------------|------|------|
| **InvitationService** | 募集の作成・更新・削除、参加管理 | Prisma、EmbedBuilder |
| **ParticipantService** | 参加者の追加・削除、ステータス管理 | Prisma |
| **TicketService** | チケットの作成・クローズ | Prisma、Discord API |
| **StaffService** | スタッフ担当の割り当て・管理 | Prisma |

#### 3.1.3 Data Access Layer

| コンポーネント | 責務 | 技術 |
|--------------|------|------|
| **Prisma Client** | 型安全なデータベースアクセス | Prisma ORM |
| **Migration管理** | スキーマ変更の履歴管理 | Prisma Migrate |

#### 3.1.4 Cross-Cutting Concerns

| コンポーネント | 責務 | 実装方法 |
|--------------|------|---------|
| **Logger** | 構造化ログ出力 | Winston/Pino |
| **Validator** | 入力検証 | Zod |
| **ErrorHandler** | 例外の統一的な処理 | グローバルエラーハンドラ |
| **Scheduler** | 定期実行ジョブ管理 | node-cron |

### 3.2 コンポーネント間の依存関係

```
┌──────────────────────────────────────────────────────────┐
│                    Discord Platform                       │
└───────────────────────┬──────────────────────────────────┘
                        │
                        ▼
┌──────────────────────────────────────────────────────────┐
│              Application Layer (Handlers)                 │
│  ┌─────────┐  ┌─────────┐  ┌──────────────────────┐     │
│  │ Event   │  │Command  │  │ Interaction Handlers │     │
│  │Handlers │  │Handlers │  │ - Button             │     │
│  │         │  │         │  │ - Modal              │     │
│  └────┬────┘  └────┬────┘  └──────────┬───────────┘     │
└───────┼────────────┼──────────────────┼─────────────────┘
        │            │                  │
        └────────────┴──────────────────┘
                     │
                     ▼
┌──────────────────────────────────────────────────────────┐
│              Business Logic Layer                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐   │
│  │ Invitation   │  │   Ticket     │  │    Staff     │   │
│  │  Service     │  │   Service    │  │   Service    │   │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘   │
└─────────┼──────────────────┼──────────────────┼──────────┘
          │                  │                  │
          └──────────────────┴──────────────────┘
                             │
                             ▼
┌──────────────────────────────────────────────────────────┐
│                Data Access Layer                          │
│                   (Prisma Client)                         │
└──────────────────────┬───────────────────────────────────┘
                       │
                       ▼
┌──────────────────────────────────────────────────────────┐
│                  PostgreSQL Database                      │
└──────────────────────────────────────────────────────────┘

                 Cross-Cutting Concerns
┌──────────────────────────────────────────────────────────┐
│  [Logger] ←─┐                                             │
│  [Validator] │  ← 全レイヤーから呼び出し                   │
│  [ErrorHandler] │                                         │
│  [Scheduler] ←─┘                                          │
└──────────────────────────────────────────────────────────┘
```

**依存の方向性:**
- 上位層 → 下位層 への単方向依存
- 下位層は上位層を知らない（疎結合）
- Cross-Cutting Concernsはどの層からも利用可能

---

## 4. 層構造とモジュール分割

### 4.1 ディレクトリ構造と層のマッピング

```
src/
├── index.ts                      # エントリポイント（Bot起動）
│
├── config/                       # 【Configuration Layer】
│   ├── env.ts                    # 環境変数の型安全な読み込み
│   └── constants.ts              # 定数定義
│
├── events/                       # 【Application Layer - Event】
│   ├── ready.ts                  # Bot起動完了イベント
│   ├── interactionCreate.ts     # インタラクション受信イベント
│   └── threadCreate.ts          # スレッド作成イベント
│
├── commands/                     # 【Application Layer - Command】
│   ├── setup.ts                  # 初期セットアップコマンド
│   └── admin.ts                  # 管理者コマンド
│
├── interactions/                 # 【Application Layer - Interaction】
│   ├── buttons/
│   │   ├── invitationButtons.ts  # 募集関連ボタン処理
│   │   └── ticketButtons.ts      # チケット関連ボタン処理
│   └── modals/
│       ├── createInvitation.ts   # 募集作成モーダル処理
│       ├── editInvitation.ts     # 募集編集モーダル処理
│       └── createTicket.ts       # チケット作成モーダル処理
│
├── services/                     # 【Business Logic Layer】
│   ├── invitationService.ts      # 募集ドメインロジック
│   ├── participantService.ts     # 参加者ドメインロジック
│   ├── ticketService.ts          # チケットドメインロジック
│   └── staffService.ts           # スタッフドメインロジック
│
├── utils/                        # 【Cross-Cutting Concerns】
│   ├── embedBuilder.ts           # Discord埋め込みメッセージ生成
│   ├── validator.ts              # 入力バリデーション
│   ├── logger.ts                 # 構造化ログ
│   └── errorHandler.ts           # エラーハンドリング
│
├── jobs/                         # 【Scheduler Layer】
│   ├── autoCloseInvitations.ts   # 自動クローズジョブ
│   └── reminderNotifications.ts  # リマインダー通知ジョブ
│
└── types/                        # 【Type Definitions】
    └── index.ts                  # 共通型定義
```

### 4.2 モジュール分割の原則

#### 凝集度の最大化
- 関連する機能を1つのモジュールに集約
- 例: `invitationService.ts` は募集に関する全てのビジネスロジックを含む

#### 結合度の最小化
- モジュール間のインターフェースを明確に定義
- 例: ServiceはPrisma Clientを直接利用するが、上位層はServiceのメソッドのみを呼び出す

#### 単一責任
- 1ファイル = 1コンポーネント
- 例: `createInvitation.ts` は募集作成モーダルのみを処理

---

## 5. 技術スタック全体像

### 5.1 技術スタックマップ

```
┌─────────────────────────────────────────────────────────────┐
│                        Runtime                               │
│                    Node.js v18+ (LTS)                        │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                      Programming Language                    │
│                    TypeScript v5.x (Strict)                  │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                    Discord Integration                       │
│                      discord.js v14.x                        │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                     Data Persistence                         │
│              Prisma ORM v5.x + PostgreSQL v14+               │
│              (開発: SQLite v3.x)                             │
└─────────────────────────────┬───────────────────────────────┘
                              │
┌─────────────────────────────▼───────────────────────────────┐
│                  Cross-Cutting Libraries                     │
│  Validation: Zod v3.x                                        │
│  Logging: Winston v3.x / Pino v8.x                           │
│  Scheduler: node-cron v3.x                                   │
│  Date/Time: date-fns v2.x                                    │
└──────────────────────────────────────────────────────────────┘
```

### 5.2 技術選定の一貫性

| 技術領域 | 選定技術 | 統一方針 |
|---------|---------|---------|
| **型システム** | TypeScript Strict Mode | 全コードで型安全性を強制 |
| **非同期処理** | async/await | Promiseチェーンではなく可読性重視 |
| **エラーハンドリング** | try-catch + カスタムエラークラス | 統一的なエラーフォーマット |
| **日時処理** | date-fns | タイムゾーン考慮、軽量 |
| **バリデーション** | Zod | スキーマ駆動、型推論 |

---

## 6. データアーキテクチャ概要

### 6.1 エンティティ関連図（ER図概要）

```
┌──────────────────────────┐
│      Invitation          │
│  (募集マスタ)             │
├──────────────────────────┤
│ PK: id (message ID)      │
│     threadId             │
│     hostId               │
│     eventName            │
│     startTime            │
│     endTime              │
│     status               │
│     ...                  │
└───────────┬──────────────┘
            │
            │ 1:N
            │
┌───────────▼──────────────┐
│      Participant         │
│  (参加者)                 │
├──────────────────────────┤
│ PK: id (Auto)            │
│ FK: invitationId         │
│     userId               │
│     status (参加/興味)    │
└──────────────────────────┘

┌──────────────────────────┐
│        Ticket            │
│  (チケット)               │
├──────────────────────────┤
│ PK: id (channel ID)      │
│     userId               │
│     category             │
│     status               │
│     createdAt            │
│     closedAt             │
└──────────────────────────┘
```

### 6.2 データ永続化戦略

- **ORM**: Prismaによる型安全なクエリ
- **トランザクション**: 重要な操作（参加登録+埋め込み更新）はトランザクション管理
- **インデックス**: 頻繁に検索されるカラム（threadId、userId、status）にインデックス
- **カスケード削除**: Invitation削除時、関連Participantも自動削除

---

## 7. セキュリティアーキテクチャ概要

### 7.1 多層防御戦略

```
┌──────────────────────────────────────────────────────────┐
│  Layer 1: Network Security                               │
│  - Discord HTTPS/WSS (TLS 1.3)                           │
│  - Database接続暗号化                                     │
└──────────────────────────────────────────────────────────┘
                         │
┌──────────────────────────▼───────────────────────────────┐
│  Layer 2: Authentication & Authorization                 │
│  - Discord OAuth 2.0                                     │
│  - ロールベースアクセス制御 (RBAC)                         │
└──────────────────────────────────────────────────────────┘
                         │
┌──────────────────────────▼───────────────────────────────┐
│  Layer 3: Input Validation                               │
│  - Zod スキーマバリデーション                             │
│  - サニタイゼーション                                     │
└──────────────────────────────────────────────────────────┘
                         │
┌──────────────────────────▼───────────────────────────────┐
│  Layer 4: Data Protection                                │
│  - 環境変数での機密情報管理                                │
│  - Prisma parameterized queries (SQLインジェクション対策) │
└──────────────────────────────────────────────────────────┘
                         │
┌──────────────────────────▼───────────────────────────────┐
│  Layer 5: Logging & Monitoring                           │
│  - 全操作のログ記録                                       │
│  - 異常検知・アラート                                     │
└──────────────────────────────────────────────────────────┘
```

### 7.2 権限モデル

| ロール | 権限 |
|--------|------|
| **一般メンバー** | 募集閲覧、参加表明、チケット作成 |
| **イベント主催者** | 自分の募集の編集・キャンセル |
| **スタッフ** | インスタンス管理、全チケット閲覧・対応 |
| **管理者** | セットアップコマンド、全データ閲覧 |

---

## 8. スケーラビリティ設計概要

### 8.1 水平スケーリング戦略

**現状（Phase 1）**: シングルインスタンス
- 400名規模のコミュニティに十分対応
- メモリ使用量: ~500MB
- CPU使用率: ~20%

**将来（Phase 2以降）**: マルチインスタンス対応
- Discord Sharding機能の活用
- ステートレス設計（セッション情報はDB保存）
- ロードバランサー配下での複数インスタンス起動

### 8.2 データベーススケーリング

```
Phase 1: 単一PostgreSQLインスタンス
         ↓
Phase 2: Read Replica追加（読み取り負荷分散）
         ↓
Phase 3: Sharding（InvitationテーブルをguildIdでシャード）
```

### 8.3 ボトルネックと対策

| ボトルネック | 対策 |
|------------|------|
| Discord API Rate Limit | レート制限監視、バックオフ、キュー実装 |
| DB接続数枯渇 | コネクションプール最適化、長時間クエリ改善 |
| メモリリーク | 定期的なヘルスチェック、メモリ監視、自動再起動 |

---

## 9. 変更容易性と拡張戦略

### 9.1 拡張ポイント

#### プラグイン可能な設計

```typescript
// 新機能追加例: 統計機能
// services/statisticsService.ts を追加するだけで既存コードは無変更

export class StatisticsService {
  async getPopularWorlds() {
    // InvitationService のデータを参照
  }
}
```

#### イベントフックシステム（将来実装）

```typescript
// イベント駆動で新機能を追加可能
eventEmitter.on('invitation:created', (invitation) => {
  // 統計記録、Webhook通知などを追加
});
```

### 9.2 技術的負債の管理

- **定期的なリファクタリング**: スプリントごとに技術的負債対応時間を確保
- **ドキュメント最新化**: コード変更時に対応ドキュメントも更新
- **テストカバレッジ維持**: 新機能追加時は必ずテストを追加

### 9.3 後方互換性戦略

- **データベース移行**: Prisma Migrateで段階的にスキーマ変更
- **API変更**: 既存の動作を壊さない追加的変更を優先
- **設定の互換性**: 環境変数の追加は後方互換を保つ

---

## 10. アーキテクチャ上の制約と決定事項

### 10.1 技術的制約

| 制約 | 理由 | 影響 |
|------|------|------|
| TypeScript必須 | 型安全性、保守性 | 学習コスト増 |
| Prisma ORM固定 | マイグレーション管理、型安全性 | ORM変更コスト高 |
| discord.js v14 | 最新Discord API対応 | 古いバージョンとの互換性なし |

### 10.2 設計上の決定

詳細は [ADR（アーキテクチャ決定記録）](../decisions/) を参照:
- [ADR-0001: TypeScript選定](../decisions/0001-typescript-selection.md)
- [ADR-0002: Prisma ORM採用](../decisions/0002-prisma-orm.md)
- [ADR-0003: フォーラムチャンネル設計](../decisions/0003-forum-channel-design.md)

---

## 関連ドキュメント

- [詳細設計](./detailed-design.md) - 各コンポーネントの実装仕様
- [データフロー](./data-flow.md) - シーケンス図、処理フロー
- [統合設計](./integration.md) - Discord API統合詳細
- [技術スタック](../tech-stack.md) - 技術選定理由
- [データベーススキーマ](../database/schema.md) - テーブル定義詳細

---

**最終更新**: 2025年11月16日  
**ドキュメントバージョン**: 1.0.0  
**レビュアー**: -
